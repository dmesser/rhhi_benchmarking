---

- hosts: hypervisors

  roles:
    - rhsm-registered
    - { role: monitoring, enable_rh_repos: false }

  vars:
    required_repos:
      - rhel-7-server-rhvh-4-rpms

  tasks:

    - name: enable required repositories
      rhsm_repository: name={{ required_repos | join(',') }}
      register: enabled_repos

    - name: Disable all repositories except required_repos
      rhsm_repository:
        name: "{{ enabled_repos.repositories |
         map(attribute='id') |
         difference(required_repos) |
         join(',' ) }}"
        state: disabled
